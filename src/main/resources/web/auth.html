<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VIAaaS Authenticator</title>
    <style>
        body {font-family: sans-serif}
    </style>
</head>
<body>
WIP TODO - authenticate to backend server via browser, proxy the Mojang Login API, does this work on 1.7 and other versions?
<p>WebSocket connection status: <span id="connection_status">?</span></p>
<p>DO NOT TYPE YOUR CREDENTIALS IF YOU DON'T TRUST THIS VIAAAS INSTANCE!</p>
<p><span id="content"></span></p>
<script>
    let urlParams = new URLSearchParams();
    window.location.search.split("?").map(it => new URLSearchParams(it).forEach((a, b) => urlParams.append(b, a)));
    var username = urlParams.get("username");
    var mcauth_code = urlParams.get("mcauth_code");
    if (urlParams.get("mcauth_success") == "false") {
        alert("Couldn't authenticate with Minecraft.ID: " + urlParams.get("mcauth_msg"));
    }

    var socket = null;
    var connectionStatus = document.getElementById("connection_status");
    var content = document.getElementById("content");

    function listen(token) {
        socket.send('{"action": "listen_login_requests", "token": "' + token + '"}');
    }

    function connect() {
        connectionStatus.innerText = "connecting...";
        socket = new WebSocket("wss://" + window.location.host + "/ws");

        socket.onerror = e => {
            console.log(e);
            connectionStatus.innerText = "socket error";
            content.innerHTML = "";
        };

        socket.onopen = () => {
            connectionStatus.innerText = "connected";
            content.innerHTML = "";

            (localStorage.getItem("tokens") || "").split(",").filter(it => it != "").forEach(listen);
        };

        socket.onclose = evt => {
            connectionStatus.innerText = "disconnected with close code " + evt.code + " and reason: " + evt.reason;
            content.innerHTML = "";
            setTimeout(connect, 5000);
        };

        socket.onmessage = event => {
            console.log(event.data.toString());
            let parsed = JSON.parse(event.data);
            if (parsed.action == "ad_minecraft_id_login") {
                if (username != null && mcauth_code != null) {
                    let add = document.createElement("a");
                    add.innerText = "Add account " + username;
                    add.href = "javascript:";
                    add.onclick = () => {
                        socket.send('{"action": "minecraft_id_login", "username": "' + username + '", "code": "' + mcauth_code + '"}');
                    };
                    content.appendChild(add);
                }
                let link = document.createElement("a");
                link.innerText = "Add account with Minecraft.ID";
                link.href = "javascript:";
                link.onclick = () => {
                    let user = prompt("Username: ", "");
                    let callbackUrl = new URL(location.origin + location.pathname + "?username=" + encodeURIComponent(user));
                    location = "https://api.minecraft.id/gateway/start/" + encodeURIComponent(user) + "?callback=" + encodeURIComponent(callbackUrl);
                };
                content.appendChild(link);
            } else if (parsed.action == "minecraft_id_result") {
                if (!parsed.success) {
                    alert("Server couldn't verify account via Minecraft.ID");
                } else {
                    listen(parsed.token);
                    let tokens = (localStorage.getItem("tokens") || "").split(",");
                    tokens.push(parsed.token);
                    localStorage.setItem("tokens", tokens.join(","));
                }
            } else if (parsed.action == "listen_login_requests_result") {
                if (parsed.success) {
                    let msg = document.createElement("p");
                    msg.innerText = "Listening to logins with username: " + parsed.username;
                    content.appendChild(msg);
                } else {
                    let tokens = (localStorage.getItem("tokens") || "").split(",");
                    tokens = tokens.filter(it => it != parsed.token);
                    localStorage.setItem("tokens", tokens.join(","));
                }
            } else if (parsed.action == "session_hash_request") {
                alert("TODO!"); // todo
                socket.send('{"action": "session_hash_response", "session_hash": "' + parsed.session_hash + '"}');
            }
        };
    }

    connect();
</script>
</body>
</html>
